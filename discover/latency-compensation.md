# 延遲補償

上一章我們介紹了 Meteor 世界的另一個新觀念：Methods（方法），這是 Meteor 非常重要的功能。

Method 是在後端執行一系列命令（程式）的一種方法，在之前的範例，因為我們希望確保貼文能加上正確的用戶名稱與 ID，還有正確的時間（主機時間，而不是用戶端的時間），所以使用了 Method。

（在其他的教學文中，Method 首要是用來在後端處理資料庫，包含了新增、更新與刪除，讓前端只需要呼叫後端的方法，而不需要真正碰觸到資料處理的層面，同時也為了安全性。）

不過就拿確保貼文時間這件事來看，如果 Method 在後端的運行方法與一般程式的執行相同，在用戶送出更新、資料庫進行處理，以及再度同步回客戶端時，總是會有一定的時間差。在某些更細緻、更縝密的應用程式環境中，這可能造成問題。

## 延遲補償

為了避免上面的問題，Meteor 引入了一個新概念：延遲補償（Latency Compensation）。當我們定義 `post` 方法時，把檔案擺在 `collections/` 目錄下，這是讓前端與後端都能使用的區域，換句話說：它在前後端同時執行！

當你呼叫一個 Method，前端將呼叫送到後端，但同時也在前端的資料集合**模擬**執行了，於是前端是立即就呈現了行動後的樣貌，稍後等到後端資料庫處理完、前端收到後端確認的回傳，在大多數的狀況下這些改變會完全一致，因此看起來、經過延遲確認後，都像是立即完成的。

萬一回傳的結果不同，例如在幾乎同時其他客戶端也做了改變（例如給予一本書五星評等、後端計算總數與平均值），Meteor 就會根據回傳後的結果，再次改變前端的資料以及呈現。換句話說，若是在大多數資料修正僅涉及單一用戶（自己）的狀況下，九成九前端模擬與後端實際回傳會是相同的。

## 觀察延遲補償

使用 `Meteor._sleepForMs()` 刻意多延遲補償幾秒鐘，先替本地模擬更新加上標記 `(client)`，等到後端的回傳到達、獲得補償後，將標記改為 `(server)`，具體觀察延遲補償的實際作用。

## 前端的資料集合方法

感覺這裡的解釋，與 [這裡](http://meteortips.com/book/methods/) 的有些不同。

Discover Meteor 將 Methods 擺在前後端都能讀到的地方，稱這是滿足延遲補償（同時進行對前端的資料處理模擬，以及後端）；但 meteortips 卻是明確的把 Methods 擺在後端。

還有，Orion-Cli 以及 Meteor Boilerplate 也都是將 Methods 擺在 `/server` 目錄，也就是只由後端處理。